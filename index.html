<!DOCTYPE html>
<html>
<head>
    <title>Agent IA - Diagnostic Groq</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,150,255,0.2);
        }
        .agent-message {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            background: #3a3a3a;
        }
        .agent-thinking {
            border-left-color: #ffc107;
            background: #4a3a00;
        }
        .agent-success {
            border-left-color: #28a745;
            background: #1a3a1a;
        }
        .agent-error {
            border-left-color: #dc3545;
            background: #3a1a1a;
        }
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .dot-green { background: #28a745; }
        .dot-red { background: #dc3545; }
        .dot-yellow { background: #ffc107; }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #363636;
        }
        .solution-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #363636;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #00ff88);
            width: 0%;
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Agent IA - Diagnostic Groq Automatique</h1>
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div id="agentMessages"></div>
        
        <div class="log" id="log">üöÄ Initialisation de l'agent IA...</div>
        
        <button onclick="startDiagnostic()">üéØ Lancer le Diagnostic Intelligent</button>
        <button onclick="applyAutoFix()">üîß Appliquer les Corrections Auto</button>
        <button onclick="location.reload()">üîÑ Red√©marrer</button>
        
        <div id="solutions" style="display: none;"></div>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 8;

        function log(message) {
            const logElement = document.getElementById('log');
            logElement.innerHTML += `\n${new Date().toLocaleTimeString()} - ${message}`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function addAgentMessage(message, type = 'info') {
            const messages = document.getElementById('agentMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `agent-message agent-${type}`;
            
            let dot = '';
            if (type === 'thinking') dot = '<span class="status-dot dot-yellow"></span>';
            if (type === 'success') dot = '<span class="status-dot dot-green"></span>';
            if (type === 'error') dot = '<span class="status-dot dot-red"></span>';
            
            messageDiv.innerHTML = `${dot}${message}`;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateProgress(step) {
            const progress = (step / totalSteps) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
            currentStep = step;
        }

        async function startDiagnostic() {
            document.getElementById('agentMessages').innerHTML = '';
            document.getElementById('log').innerHTML = 'üöÄ Initialisation du diagnostic...';
            document.getElementById('solutions').style.display = 'none';
            currentStep = 0;

            addAgentMessage('ü§ñ Agent IA activ√© - D√©but du diagnostic Groq complet...', 'thinking');
            
            // Test 1: Connexion de base
            await testConnexionBasique();
            
            // Test 2: Mod√®les disponibles
            await testModeles();
            
            // Test 3: Configuration Vercel
            await testConfigurationVercel();
            
            // Test 4: Cl√© API
            await testCleAPI();
            
            // G√©n√©rer le rapport final
            await genererRapport();
        }

        async function testConnexionBasique() {
            updateProgress(1);
            addAgentMessage('üîç Test 1/4: Connexion API de base...', 'thinking');
            log('Test connexion basique...');

            try {
                const response = await fetch('/api/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: "Test" }],
                        model: "llama-3.1-70b-versatile",
                        max_tokens: 5
                    })
                });

                if (response.ok) {
                    addAgentMessage('‚úÖ Connexion API fonctionnelle', 'success');
                    log('SUCC√àS: API r√©pond correctement');
                    return true;
                } else {
                    const error = await response.json();
                    addAgentMessage(`‚ùå Erreur API: ${response.status}`, 'error');
                    log(`ERREUR: ${response.status} - ${JSON.stringify(error)}`);
                    return false;
                }
            } catch (error) {
                addAgentMessage('‚ùå Impossible de contacter le serveur', 'error');
                log(`ERREUR: ${error.message}`);
                return false;
            }
        }

        async function testModeles() {
            updateProgress(2);
            addAgentMessage('üîç Test 2/4: Recherche de mod√®les fonctionnels...', 'thinking');
            
            const modeles = [
                'llama-3.1-70b-versatile',
                'llama-3.1-8b-instant',
                'mixtral-8x7b-32768',
                'gemma2-9b-it',
                'llama2-70b-4096'
            ];

            let modeleFonctionnel = null;

            for (const modele of modeles) {
                log(`Test du mod√®le: ${modele}`);
                try {
                    const response = await fetch('/api/groq', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [{ role: "user", content: "OK" }],
                            model: modele,
                            max_tokens: 5
                        })
                    });

                    if (response.ok) {
                        modeleFonctionnel = modele;
                        addAgentMessage(`‚úÖ Mod√®le trouv√©: ${modele}`, 'success');
                        log(`SUCC√àS: ${modele} fonctionne`);
                        break;
                    }
                } catch (error) {
                    log(`√âchec: ${modele} - ${error.message}`);
                }
            }

            if (!modeleFonctionnel) {
                addAgentMessage('‚ùå Aucun mod√®le Groq ne fonctionne', 'error');
            }
        }

        async function testConfigurationVercel() {
            updateProgress(3);
            addAgentMessage('üîç Test 3/4: Diagnostic configuration Vercel...', 'thinking');
            log('V√©rification configuration Vercel...');

            // Test des endpoints
            const endpoints = ['/api/groq', '/api/test', '/api/debug'];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, { method: 'HEAD' });
                    log(`${endpoint} - Status: ${response.status}`);
                } catch (error) {
                    log(`${endpoint} - Erreur: ${error.message}`);
                }
            }

            addAgentMessage('üìä Configuration Vercel analys√©e', 'thinking');
        }

        async function testCleAPI() {
            updateProgress(4);
            addAgentMessage('üîç Test 4/4: Validation cl√© API...', 'thinking');
            log('Test de la cl√© API Groq...');

            // Test direct Groq (simulation)
            try {
                const response = await fetch('/api/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{ role: "user", content: "R√©ponds OK" }],
                        model: "llama-3.1-70b-versatile",
                        max_tokens: 10
                    })
                });

                const data = await response.json();
                
                if (response.status === 401) {
                    addAgentMessage('‚ùå Cl√© API Groq invalide ou expir√©e', 'error');
                    log('ERREUR: Cl√© API rejet√©e par Groq');
                } else if (response.status === 500) {
                    addAgentMessage('‚ö†Ô∏è Probl√®me de configuration serveur', 'error');
                    log('ERREUR: Configuration serveur incorrecte');
                } else if (response.ok) {
                    addAgentMessage('‚úÖ Cl√© API valide et fonctionnelle', 'success');
                    log('SUCC√àS: Cl√© API accept√©e par Groq');
                }
            } catch (error) {
                addAgentMessage('‚ùå Erreur lors du test de la cl√© API', 'error');
                log(`ERREUR: ${error.message}`);
            }
        }

        async function genererRapport() {
            updateProgress(5);
            addAgentMessage('üìä G√©n√©ration du rapport de diagnostic...', 'thinking');
            
            await new Promise(resolve => setTimeout(resolve, 2000));

            const solutions = document.getElementById('solutions');
            solutions.style.display = 'block';
            solutions.innerHTML = `
                <div class="solution-box">
                    <h3>üéØ SOLUTIONS RECOMMAND√âES PAR L'AGENT IA</h3>
                    <div class="test-result">
                        <strong>1. V√©rifier la cl√© API sur Vercel</strong><br>
                        - Allez dans Settings ‚Üí Environment Variables<br>
                        - V√©rifiez que GROQ_API_KEY existe<br>
                        - Red√©ployez l'application
                    </div>
                    <div class="test-result">
                        <strong>2. Mod√®le Groq fonctionnel</strong><br>
                        - Utilisez "llama-3.1-70b-versatile"<br>
                        - √âvitez "mixtral-8x7b-32768" (d√©commissionn√©)
                    </div>
                    <div class="test-result">
                        <strong>3. Configuration API</strong><br>
                        - V√©rifiez que api/groq.js est d√©ploy√©<br>
                        - V√©rifiez les logs Vercel pour les erreurs
                    </div>
                </div>
            `;

            updateProgress(8);
            addAgentMessage('‚úÖ Diagnostic complet termin√©!', 'success');
            addAgentMessage('üìã Les solutions recommand√©es sont affich√©es ci-dessous.', 'success');
        }

        function applyAutoFix() {
            addAgentMessage('üîß Application des corrections automatiques...', 'thinking');
            
            // Correction automatique du mod√®le
            const correctionCode = `
// api/groq.js - Version corrig√©e automatiquement
export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') return res.status(200).end();
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  const GROQ_API_KEY = process.env.GROQ_API_KEY;

  if (!GROQ_API_KEY) {
    return res.status(500).json({ error: 'GROQ_API_KEY manquante' });
  }

  try {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': \`Bearer \${GROQ_API_KEY}\`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ...req.body,
        model: "llama-3.1-70b-versatile" // Mod√®le garanti fonctionnel
      }),
    });

    const data = await response.json();
    res.status(response.status).json(data);
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
}
            `;

            addAgentMessage('üìù Code corrig√© g√©n√©r√© - Copiez-le dans api/groq.js', 'success');
            log('CODE CORRIG√â:\n' + correctionCode);
            
            // Cr√©er un √©l√©ment de t√©l√©chargement
            const blob = new Blob([correctionCode], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'groq-fixed.js';
            a.click();
            
            addAgentMessage('üì• Fichier de correction t√©l√©charg√©!', 'success');
        }

        // D√©marrer automatiquement
        setTimeout(startDiagnostic, 2000);
    </script>
</body>
</html>
