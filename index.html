<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Uploader un document ascenseur</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; background-color: #f9f9f9; }
    h2 { color: #333; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    select, input[type="text"], input[type="file"] {
      width: 100%; padding: 8px; margin-top: 6px; box-sizing: border-box;
      border: 1px solid #ccc; border-radius: 4px;
    }
    button {
      margin-top: 20px; padding: 10px 16px;
      background-color: #0077cc; color: white; border: none; border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background-color: #005fa3; }
    .note { color: #666; margin-top: 12px; font-size: 0.9em; }
    .error { color: #a00; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>üì§ Uploader un document ascenseur</h2>

  <label>Marque existante :
    <select id="marqueSelect"><option>Chargement...</option></select>
  </label>

  <label>Nouvelle marque (facultatif) :
    <input type="text" id="newMarque" placeholder="Ex: thyssenkrupp">
  </label>

  <label>Mod√®le existant :
    <select id="modeleSelect"><option>Chargement...</option></select>
  </label>

  <label>Nouveau mod√®le (facultatif) :
    <input type="text" id="newModele" placeholder="Ex: GEN2">
  </label>

  <label>Type de document :
    <select id="typeDoc">
      <option value="technique">Technique</option>
      <option value="schema">Sch√©ma</option>
    </select>
  </label>

  <label>Description :
    <input type="text" id="description" placeholder="Ex: sch√©ma √©lectrique, manuel utilisateur">
  </label>

  <label>Choisir un fichier :
    <input type="file" id="fileInput">
  </label>

  <button id="submitBtn">üìé Envoyer le document</button>

  <p class="note">Assure-toi que ta table <strong>documents</strong> contient les colonnes : marque, modele, filename, path, type_doc, description.</p>
  <p id="debug" class="error"></p>

  <script>
    const supabaseUrl = "https://zrsarbork8nseemnu.supabase.co";
    const supabaseKey = "9a3e3c4f5a9e8e1c1e3f4a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d";
    const headers = {
      apikey: supabaseKey,
      Authorization: `Bearer ${supabaseKey}`,
    };

    const marqueSelect = document.getElementById('marqueSelect');
    const modeleSelect = document.getElementById('modeleSelect');
    const debugEl = document.getElementById('debug');

    function emptySelect(sel, text) {
      sel.innerHTML = "";
      const o = document.createElement('option');
      o.textContent = text;
      o.value = "";
      sel.appendChild(o);
    }

    async function loadOptions() {
      emptySelect(marqueSelect, "Chargement...");
      emptySelect(modeleSelect, "Chargement...");

      try {
        const res = await fetch(`${supabaseUrl}/rest/v1/documents?select=marque,modele`, { headers });
        const data = await res.json();

        const marques = [...new Set(data.map(row => row.marque).filter(Boolean))];
        const modeles = [...new Set(data.map(row => row.modele).filter(Boolean))];

        marqueSelect.innerHTML = `<option value="">-- Choisir une marque --</option>` +
          marques.map(m => `<option value="${m}">${m}</option>`).join('');

        modeleSelect.innerHTML = `<option value="">-- Choisir un mod√®le --</option>` +
          modeles.map(m => `<option value="${m}">${m}</option>`).join('');

        debugEl.textContent = "";
      } catch (err) {
        console.error(err);
        debugEl.textContent = "Erreur chargement marques/mod√®les : " + err.message;
      }
    }

    loadOptions();

    document.getElementById('submitBtn').addEventListener('click', async () => {
      const file = document.getElementById('fileInput').files[0];
      const marque = document.getElementById('newMarque').value.trim() || marqueSelect.value;
      const modele = document.getElementById('newModele').value.trim() || modeleSelect.value;
      const type_doc = document.getElementById('typeDoc').value;
      const description = document.getElementById('description').value.trim();

      if (!marque || !modele || !file) {
        alert("Remplis tous les champs obligatoires.");
        return;
      }

      const path = `documents/${Date.now()}-${file.name}`;

      try {
        const uploadRes = await fetch(`${supabaseUrl}/storage/v1/object/${path}`, {
          method: "PUT",
          headers: { "Content-Type": file.type, ...headers },
          body: file
        });
        if (!uploadRes.ok) throw new Error("Upload √©chou√©");

        const meta = {
          marque, modele,
          filename: file.name,
          path,
          type_doc,
          description
        };

        const insertRes = await fetch(`${supabaseUrl}/rest/v1/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json", ...headers },
          body: JSON.stringify(meta)
        });
        if (!insertRes.ok) throw new Error("Enregistrement √©chou√©");

        alert("‚úÖ Document enregistr√© avec succ√®s !");
        loadOptions();
      } catch (err) {
        console.error(err);
        alert("Erreur : " + err.message);
      }
    });
  </script>
</body>
</html>
