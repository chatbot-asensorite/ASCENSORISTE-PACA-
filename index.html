<!DOCTYPE html>
<html>
<head>
    <title>Test Groq + Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test Groq avec vos PDF</h1>
    
    <div>
        <h3>Configuration Supabase :</h3>
        <input type="text" id="supabaseUrl" placeholder="URL Supabase" style="width: 400px; margin: 5px;"><br>
        <input type="text" id="supabaseKey" placeholder="Cl√© API publique Supabase" style="width: 400px; margin: 5px;">
    </div>

    <div>
        <h3>Question technique :</h3>
        <textarea id="question" placeholder="Posez une question sur vos ascenseurs..." rows="4" cols="50"></textarea><br>
        <button onclick="demanderGroq()">Tester Groq</button>
    </div>

    <div id="resultat" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>

    <script>
        async function demanderGroq() {
            const supabaseUrl = document.getElementById('supabaseUrl').value;
            const supabaseKey = document.getElementById('supabaseKey').value;
            const question = document.getElementById('question').value;

            if (!supabaseUrl || !supabaseKey || !question) {
                alert('Remplissez tous les champs !');
                return;
            }

            // Initialisation Supabase
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            
            document.getElementById('resultat').innerHTML = 'üîç Recherche dans vos PDF...';

            try {
                // 1. R√©cup√©rer la liste des PDF
                const { data: fichiers, error } = await supabase.storage
                    .from('documents-techniques')
                    .list('', { limit: 50 });

                if (error) throw error;

                document.getElementById('resultat').innerHTML = `üìÅ ${fichiers.length} fichiers trouv√©s<br>Analyse avec Groq...`;

                // 2. Envoyer √† Groq (version simplifi√©e)
                const reponse = await fetch('/api/groq', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [{
                            role: "user",
                            content: `J'ai ces documents techniques: ${fichiers.map(f => f.name).join(', ')}. Question: ${question}`
                        }],
                        model: "llama-3.1-8b-instant",
                        max_tokens: 500
                    })
                });

                const data = await reponse.json();
                document.getElementById('resultat').innerHTML = 
                    `<strong>R√©ponse Groq :</strong><br>${data.choices[0].message.content}`;

            } catch (error) {
                document.getElementById('resultat').innerHTML = `‚ùå Erreur: ${error.message}`;
            }
        }
    </script>
</body>
</html>
