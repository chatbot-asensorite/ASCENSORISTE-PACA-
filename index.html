<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ascensoriste PACA - Administration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://prrzsosrbrskmeozmmmu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBycnpzb3NyYnJza21lb3ptbW11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTkwMDMsImV4cCI6MjA3Njg5NTAwM30.JuqL6tJC5LRXX3OHXrznm_v9bca-aOJ_vnk_wPsP9Mc';
        const BUCKET_NAME = 'documents-pdfs';

        // Initialisation
        let supabase;
        let currentUser = null;
        let OPTIONS = {
            marques: [],
            types: [],
            categories: []
        };
        const OPTIONS_MAP = {
            marque: { table: 'marques', select: 'input-marque', status: 'add-status-marque', container: 'manage-marques-list' },
            type: { table: 'types_ascenseur', select: 'input-type', status: 'add-status-type', container: 'manage-types-list' },
            categorie: { table: 'categories', select: 'input-categorie', status: 'add-status-categorie', container: 'manage-categories-list' }
        };

        // =================================================================
        // FONCTIONS D'AUTHENTIFICATION
        // =================================================================

        // Initialisation de l'app
        async function initApp() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Supabase initialis√©');
                
                // V√©rifier si l'utilisateur est d√©j√† connect√©
                await checkCurrentUser();
                await testConnection();
                
            } catch (error) {
                console.error('Erreur initialisation:', error);
                showError('Erreur de configuration Supabase');
            }
        }

        // V√©rifier l'utilisateur actuel
        async function checkCurrentUser() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                showAdminInterface();
                await initInterface();
            } else {
                showLoginInterface();
            }
        }

        // Connexion
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const statusElement = document.getElementById('login-status');

            if (!email || !password) {
                statusElement.textContent = "Veuillez remplir tous les champs";
                statusElement.className = 'text-red-500';
                return;
            }

            statusElement.textContent = "üîê Connexion...";
            statusElement.className = 'text-blue-500';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                statusElement.textContent = "‚úÖ Connexion r√©ussie!";
                statusElement.className = 'text-green-500';
                
                setTimeout(() => {
                    showAdminInterface();
                    initInterface();
                }, 1000);

            } catch (error) {
                console.error('Erreur connexion:', error);
                statusElement.textContent = `‚ùå Erreur: ${error.message}`;
                statusElement.className = 'text-red-500';
            }
        }

        // D√©connexion
        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            showLoginInterface();
        }

        // Afficher l'interface de connexion
        function showLoginInterface() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
        }

        // Afficher l'interface admin
        function showAdminInterface() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('current-user-email').textContent = currentUser.email;
        }

        // =================================================================
        // GESTION DES TECHNICIENS
        // =================================================================

        // Cr√©er un compte technicien
        async function createTechnician() {
            const email = document.getElementById('tech-email').value;
            const password = document.getElementById('tech-password').value;
            const nom = document.getElementById('tech-nom').value;
            const prenom = document.getElementById('tech-prenom').value;
            const statusElement = document.getElementById('tech-status');

            if (!email || !password || !nom || !prenom) {
                statusElement.textContent = "Veuillez remplir tous les champs";
                statusElement.className = 'text-red-500';
                return;
            }

            statusElement.textContent = "üîÑ Cr√©ation du compte...";
            statusElement.className = 'text-blue-500';

            try {
                // 1. Cr√©er l'utilisateur dans l'auth
                const { data: authData, error: authError } = await supabase.auth.admin.createUser({
                    email: email,
                    password: password,
                    email_confirm: true,
                    user_metadata: {
                        nom: nom,
                        prenom: prenom,
                        role: 'technicien'
                    }
                });

                if (authError) throw authError;

                // 2. Ajouter dans la table techniciens
                const { error: dbError } = await supabase
                    .from('techniciens')
                    .insert([{
                        id: authData.user.id,
                        email: email,
                        nom: nom,
                        prenom: prenom,
                        role: 'technicien',
                        date_creation: new Date().toISOString()
                    }]);

                if (dbError) throw dbError;

                statusElement.textContent = "‚úÖ Technicien cr√©√© avec succ√®s!";
                statusElement.className = 'text-green-500';
                
                // R√©initialiser le formulaire
                document.getElementById('tech-form').reset();
                
                // Recharger la liste
                loadTechnicians();

            } catch (error) {
                console.error('Erreur cr√©ation technicien:', error);
                statusElement.textContent = `‚ùå Erreur: ${error.message}`;
                statusElement.className = 'text-red-500';
            }
        }

        // Charger la liste des techniciens
        async function loadTechnicians() {
            const tbody = document.getElementById('techniciens-list');
            const statusElement = document.getElementById('tech-list-status');

            statusElement.textContent = "üîÑ Chargement...";
            tbody.innerHTML = '';

            try {
                const { data: techniciens, error } = await supabase
                    .from('techniciens')
                    .select('*')
                    .order('date_creation', { ascending: false });

                if (error) throw error;

                if (!techniciens || techniciens.length === 0) {
                    statusElement.textContent = "Aucun technicien trouv√©";
                    return;
                }

                statusElement.textContent = `üë• ${techniciens.length} technicien(s)`;

                techniciens.forEach(tech => {
                    const row = tbody.insertRow();
                    row.className = 'hover:bg-gray-50 border-b';
                    row.innerHTML = `
                        <td class="p-3 text-sm">${tech.prenom} ${tech.nom}</td>
                        <td class="p-3 text-sm">${tech.email}</td>
                        <td class="p-3 text-sm">
                            <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">${tech.role}</span>
                        </td>
                        <td class="p-3 text-sm">${new Date(tech.date_creation).toLocaleDateString('fr-FR')}</td>
                        <td class="p-3 text-sm">
                            <button onclick="resetTechnicianPassword('${tech.id}', '${tech.email}')" 
                                    class="text-blue-600 hover:text-blue-800 font-semibold text-sm mr-3">
                                üîë R√©init MDP
                            </button>
                            <button onclick="deleteTechnician('${tech.id}', '${tech.email}')" 
                                    class="text-red-600 hover:text-red-800 font-semibold text-sm">
                                üóëÔ∏è Supprimer
                            </button>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Erreur chargement techniciens:', error);
                statusElement.textContent = "‚ùå Erreur de chargement";
            }
        }

        // R√©initialiser le mot de passe
        async function resetTechnicianPassword(techId, techEmail) {
            const newPassword = prompt(`R√©initialiser le mot de passe pour ${techEmail} :\n(8 caract√®res minimum)`);
            
            if (!newPassword || newPassword.length < 8) {
                alert('Le mot de passe doit faire au moins 8 caract√®res');
                return;
            }

            try {
                const { error } = await supabase.auth.admin.updateUserById(
                    techId,
                    { password: newPassword }
                );

                if (error) throw error;

                alert('‚úÖ Mot de passe r√©initialis√© avec succ√®s!');

            } catch (error) {
                console.error('Erreur reset password:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // Supprimer un technicien
        async function deleteTechnician(techId, techEmail) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le technicien ${techEmail} ?`)) {
                return;
            }

            try {
                // 1. Supprimer de la table techniciens
                const { error: dbError } = await supabase
                    .from('techniciens')
                    .delete()
                    .eq('id', techId);

                if (dbError) throw dbError;

                // 2. Supprimer le compte auth (optionnel - attention!)
                // const { error: authError } = await supabase.auth.admin.deleteUser(techId);
                // if (authError) console.warn("Impossible de supprimer le compte auth:", authError);

                alert('‚úÖ Technicien supprim√© avec succ√®s!');
                loadTechnicians();

            } catch (error) {
                console.error('Erreur suppression technicien:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // =================================================================
        // FONCTIONS EXISTANTES (Gestion documents et options)
        // =================================================================

        async function initInterface() {
            await loadOptions();
            loadDocuments();
            loadTechnicians(); // Charger les techniciens
        }

        async function loadOptions() {
            const promises = [
                supabase.from(OPTIONS_MAP.marque.table).select('id, nom').order('nom', { ascending: true }),
                supabase.from(OPTIONS_MAP.type.table).select('id, nom').order('nom', { ascending: true }),
                supabase.from(OPTIONS_MAP.categorie.table).select('id, nom').order('nom', { ascending: true })
            ];

            const [marquesRes, typesRes, categoriesRes] = await Promise.all(promises);

            if (marquesRes.error) console.error("Erreur chargement marques:", marquesRes.error);
            if (typesRes.error) console.error("Erreur chargement types:", typesRes.error);
            if (categoriesRes.error) console.error("Erreur chargement categories:", categoriesRes.error);

            OPTIONS.marques = marquesRes.data || [];
            OPTIONS.types = typesRes.data || [];
            OPTIONS.categories = categoriesRes.data || [];

            populateSelect('input-marque', OPTIONS.marques);
            populateSelect('input-type', OPTIONS.types);
            populateSelect('input-categorie', OPTIONS.categories);

            updateManageList('marque', OPTIONS.marques);
            updateManageList('type', OPTIONS.types);
            updateManageList('categorie', OPTIONS.categories);
        }

        function populateSelect(selectId, dataArray) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = '<option value="" disabled selected>-- S√©lectionner --</option>';
            dataArray.forEach(item => {
                const option = document.createElement('option');
                option.value = item.nom;
                option.textContent = item.nom;
                select.appendChild(option);
            });

            if (currentValue && dataArray.some(item => item.nom === currentValue)) {
                 select.value = currentValue;
            }
        }

        async function addNewOption(listType) {
            const config = OPTIONS_MAP[listType];
            const inputId = `new-input-${listType}`;
            const newValue = document.getElementById(inputId).value.trim();
            const statusElement = document.getElementById(config.status);

            if (!newValue) {
                statusElement.textContent = 'Veuillez entrer une valeur.';
                statusElement.className = 'text-red-500';
                return;
            }
            
            const currentList = OPTIONS[listType === 'marque' ? 'marques' : listType === 'type' ? 'types' : 'categories'];
            if (currentList.some(item => item.nom.toLowerCase() === newValue.toLowerCase())) {
                statusElement.textContent = `${newValue} existe d√©j√†.`;
                statusElement.className = 'text-red-500';
                return;
            }

            statusElement.textContent = 'üîÑ Ajout en cours...';
            statusElement.className = 'text-blue-500';

            try {
                const { error } = await supabase
                    .from(config.table)
                    .insert([{ nom: newValue }]);

                if (error) throw error;
                
                document.getElementById(inputId).value = '';
                statusElement.textContent = `‚úÖ ${newValue} ajout√© avec succ√®s.`;
                statusElement.className = 'text-green-500';

                await loadOptions();

            } catch (error) {
                console.error(`Erreur ajout ${listType}:`, error);
                statusElement.innerHTML = `‚ùå Erreur: ${error.message}`;
                statusElement.className = 'text-red-500';
            }
        }

        function updateManageList(listType, dataArray) {
            const config = OPTIONS_MAP[listType];
            const container = document.getElementById(config.container);
            container.innerHTML = '';
            
            dataArray.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-1 border-b border-gray-200';
                div.innerHTML = `
                    <span class="text-sm text-gray-700">${item.nom}</span>
                    <button type="button" onclick="deleteOption('${config.table}', '${item.id}', '${item.nom}')" 
                            title="Supprimer ${item.nom}"
                            class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        async function deleteOption(table, id, nom) {
             const statusElement = document.getElementById('connection-status');
             
             if (!confirm(`ATTENTION: √ätes-vous s√ªr de vouloir supprimer "${nom}" ?\nSi cette option est utilis√©e par des documents existants, ils conserveront la valeur mais l'option ne sera plus s√©lectionnable !`)) {
                return;
            }

            statusElement.innerHTML = `üîÑ Suppression de ${nom}...`;
            statusElement.className = 'p-3 bg-blue-100 border border-blue-400 text-blue-700 rounded';

            try {
                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) {
                    if (error.message.includes('foreign key constraint')) {
                         throw new Error(`Impossible de supprimer "${nom}". Des documents y font encore r√©f√©rence.`);
                    }
                    throw error;
                }

                statusElement.innerHTML = `‚úÖ "${nom}" a √©t√© supprim√©.`;
                statusElement.className = 'p-3 bg-green-100 border border-green-400 text-green-700 rounded';
                
                await loadOptions();
                loadDocuments();

            } catch (error) {
                console.error(`Erreur suppression option:`, error);
                statusElement.innerHTML = `‚ùå Erreur: ${error.message}`;
                statusElement.className = 'p-3 bg-red-100 border border-red-400 text-red-700 rounded';
            }
        }

        async function uploadDocument(file, metadata) {
            const statusElement = document.getElementById('upload-status');
            statusElement.textContent = "üì§ T√©l√©chargement en cours...";
            statusElement.className = 'text-blue-500';

            try {
                const timestamp = Date.now();
                const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
                const safeModel = metadata.model.replace(/[^a-zA-Z0-9]/g, '_');
                const filePath = `${metadata.marque}/${safeModel}/${timestamp}_${safeName}`;
                
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                const { data: urlData } = supabase.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(filePath);

                const documentData = {
                    marque: metadata.marque,
                    type_ascenseur: metadata.type_ascenseur,
                    categorie: metadata.categorie, 
                    model: metadata.model, 
                    nom_fichier: file.name,
                    fichier_url: urlData.publicUrl,
                    uploaded_by: currentUser.id
                };

                const { error: dbError } = await supabase
                    .from('documents')
                    .insert([documentData]);

                if (dbError) throw dbError;

                statusElement.textContent = "‚úÖ Document enregistr√© avec succ√®s!";
                statusElement.className = 'text-green-500';
                
                document.getElementById('upload-form').reset();
                document.getElementById('file-name-display').textContent = 'Aucun fichier s√©lectionn√©';
                
                loadDocuments();

            } catch (error) {
                console.error('Erreur upload:', error);
                statusElement.innerHTML = `‚ùå Erreur: ${error.message}`;
                statusElement.className = 'text-red-500';
            }
        }

        async function loadDocuments() {
            const tableBody = document.getElementById('documents-table-body');
            const statusText = document.getElementById('documents-status');
            
            statusText.textContent = "üîÑ Chargement...";
            tableBody.innerHTML = '';

            try {
                const { data: documents, error } = await supabase
                    .from('documents')
                    .select('id, marque, type_ascenseur, categorie, model, nom_fichier, fichier_url, created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!documents || documents.length === 0) {
                    statusText.textContent = "üìù Aucun document trouv√©. Ajoutez le premier!";
                    return;
                }

                statusText.textContent = `üìö ${documents.length} document(s) charg√©(s)`;
                
                updateFilterOptions('filter-marque', OPTIONS.marques.map(o => o.nom));
                updateFilterOptions('filter-type', OPTIONS.types.map(o => o.nom));
                updateFilterOptions('filter-categorie', OPTIONS.categories.map(o => o.nom));

                documents.forEach(doc => {
                    const row = tableBody.insertRow();
                    row.className = 'hover:bg-gray-50 border-b';
                    row.innerHTML = `
                        <td class="p-3 text-sm">${doc.marque}</td>
                        <td class="p-3 text-sm">${doc.type_ascenseur}</td>
                        <td class="p-3 text-sm">${doc.categorie}</td>
                        <td class="p-3 text-sm">${doc.model}</td>
                        <td class="p-3 text-sm">${doc.nom_fichier}</td>
                        <td class="p-3 text-sm">
                            <div class="flex space-x-3">
                                <button onclick="window.open('${doc.fichier_url}', '_blank')" 
                                        class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                    Voir
                                </button>
                                <button onclick="deleteDocument(${doc.id}, '${doc.fichier_url}')" 
                                        class="text-red-600 hover:text-red-800 font-semibold flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    Supprimer
                                </button>
                            </div>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Erreur chargement:', error);
                statusText.textContent = "‚ùå Erreur de chargement: " + error.message;
            }
        }

        async function deleteDocument(id, fileUrl) {
            const statusElement = document.getElementById('documents-status');
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ce document ?\nID: ${id}`)) return;

            statusElement.textContent = `üîÑ Suppression du document ${id}...`;

            try {
                const url = new URL(fileUrl);
                const pathParts = url.pathname.split(`/${BUCKET_NAME}/`);
                const filePath = pathParts[1];

                if (!filePath) throw new Error("Impossible d'extraire le chemin du fichier depuis l'URL.");

                const { error: storageError } = await supabase.storage
                    .from(BUCKET_NAME)
                    .remove([filePath]);

                if (storageError && storageError.statusCode !== 404) {
                    console.warn("Erreur suppression Storage, tentative de suppression DB:", storageError.message);
                }

                const { error: dbError } = await supabase
                    .from('documents')
                    .delete()
                    .eq('id', id);

                if (dbError) throw dbError;

                statusElement.textContent = `‚úÖ Document ${id} supprim√© avec succ√®s.`;
                loadDocuments();

            } catch (error) {
                console.error('Erreur suppression:', error);
                statusElement.textContent = `‚ùå Erreur de suppression: ${error.message}`;
            }
        }

        function updateFilterOptions(selectId, dataArray) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Tous</option>';
            [...new Set(dataArray)].sort().forEach(item => {
                if (item && item.trim()) {
                    const option = document.createElement('option');
                    option.value = item.trim();
                    option.textContent = item.trim();
                    select.appendChild(option);
                }
            });

            if (currentValue && dataArray.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        async function applyFilters() {
            const marque = document.getElementById('filter-marque').value;
            const type = document.getElementById('filter-type').value;
            const categorie = document.getElementById('filter-categorie').value;
            const model = document.getElementById('filter-model').value.toLowerCase();
            const recherche = document.getElementById('filter-search').value.toLowerCase();
            
            const tableBody = document.getElementById('documents-table-body');
            const statusText = document.getElementById('documents-status');
            
            statusText.textContent = "üîç Filtrage...";
            tableBody.innerHTML = '';

            try {
                let query = supabase.from('documents').select('*');

                if (marque) query = query.eq('marque', marque);
                if (type) query = query.eq('type_ascenseur', type);
                if (categorie) query = query.eq('categorie', categorie);
                if (model) query = query.ilike('model', `%${model}%`);
                if (recherche) query = query.ilike('nom_fichier', `%${recherche}%`);
                
                const { data: filteredDocuments, error } = await query;
                
                if (error) throw error;
                
                if (filteredDocuments.length === 0) {
                    statusText.textContent = "üîç Aucun document ne correspond aux crit√®res.";
                    return;
                }
                
                statusText.textContent = `üìä ${filteredDocuments.length} document(s) filtr√©(s)`;
                
                filteredDocuments.forEach(doc => {
                    const row = tableBody.insertRow();
                    row.className = 'hover:bg-gray-50 border-b';
                    row.innerHTML = `
                        <td class="p-3 text-sm">${doc.marque}</td>
                        <td class="p-3 text-sm">${doc.type_ascenseur}</td>
                        <td class="p-3 text-sm">${doc.categorie}</td>
                        <td class="p-3 text-sm">${doc.model}</td>
                        <td class="p-3 text-sm">${doc.nom_fichier}</td>
                        <td class="p-3 text-sm">
                            <div class="flex space-x-3">
                                <button onclick="window.open('${doc.fichier_url}', '_blank')" 
                                        class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                    Voir
                                </button>
                                <button onclick="deleteDocument(${doc.id}, '${doc.fichier_url}')" 
                                        class="text-red-600 hover:text-red-800 font-semibold flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                    Supprimer
                                </button>
                            </div>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Erreur filtrage:', error);
                statusText.textContent = "‚ùå Erreur lors du filtrage: " + error.message;
            }
        }

        async function testConnection() {
            const statusElement = document.getElementById('connection-status');
            try {
                statusElement.innerHTML = 'üîÑ Test de connexion...';
                
                const { data, error } = await supabase.from('marques').select('*').limit(1);

                if (error) throw error;

                statusElement.innerHTML = '‚úÖ <strong>Connexion r√©ussie!</strong> Base de donn√©es op√©rationnelle.';
                statusElement.className = 'p-3 bg-green-100 border border-green-400 text-green-700 rounded';
                
            } catch (error) {
                console.error('Erreur connexion:', error);
                let errorMsg = error.message;
                statusElement.innerHTML = `‚ùå Erreur de connexion: ${errorMsg}`;
                statusElement.className = 'p-3 bg-red-100 border border-red-400 text-red-700 rounded';
            }
        }

        // Fonctions globales
        window.login = login;
        window.logout = logout;
        window.createTechnician = createTechnician;
        window.resetTechnicianPassword = resetTechnicianPassword;
        window.deleteTechnician = deleteTechnician;
        window.deleteOption = deleteOption;
        window.deleteDocument = deleteDocument;
        window.addNewOption = addNewOption;
        window.applyFilters = applyFilters;
        window.testConnection = testConnection;
        window.toggleCollapsible = function(id) {
            const content = document.getElementById(id);
            const isExpanded = content.classList.contains('collapsible-open');
            document.querySelectorAll('.collapsible-content').forEach(c => c.classList.remove('collapsible-open'));
            
            if (!isExpanded) {
                content.classList.add('collapsible-open');
            }
        };

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', function() {
            // √âv√©nement formulaire upload
            document.getElementById('upload-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('pdf-file');
                const file = fileInput.files[0];
                
                if (!file) {
                    document.getElementById('upload-status').textContent = "‚ùå Veuillez s√©lectionner un fichier PDF.";
                    document.getElementById('upload-status').className = 'text-red-500';
                    return;
                }

                if (file.type !== 'application/pdf') {
                    document.getElementById('upload-status').textContent = "‚ùå Seuls les fichiers PDF sont accept√©s.";
                    document.getElementById('upload-status').className = 'text-red-500';
                    return;
                }

                const metadata = {
                    marque: document.getElementById('input-marque').value.trim(),
                    type_ascenseur: document.getElementById('input-type').value.trim(),
                    categorie: document.getElementById('input-categorie').value.trim(),
                    model: document.getElementById('input-model').value.trim(),
                };

                if (!metadata.marque || !metadata.type_ascenseur || !metadata.categorie || !metadata.model) {
                    document.getElementById('upload-status').textContent = "‚ùå Tous les champs sont obligatoires.";
                    document.getElementById('upload-status').className = 'text-red-500';
                    return;
                }

                uploadDocument(file, metadata);
            });

            // Afficher le nom du fichier
            document.getElementById('pdf-file').addEventListener('change', function() {
                const display = document.getElementById('file-name-display');
                const modelInput = document.getElementById('input-model');
                
                if (this.files.length > 0) {
                    const fileName = this.files[0].name;
                    display.textContent = fileName;
                    modelInput.value = fileName.replace(/\.pdf$/i, '').trim();
                } else {
                    display.textContent = 'Aucun fichier s√©lectionn√©';
                    modelInput.value = '';
                }
            });

            // √âv√©nements pour les filtres
            document.getElementById('filter-marque').addEventListener('change', applyFilters);
            document.getElementById('filter-type').addEventListener('change', applyFilters);
            document.getElementById('filter-categorie').addEventListener('change', applyFilters);
            document.getElementById('filter-model').addEventListener('input', applyFilters);
            document.getElementById('filter-search').addEventListener('input', applyFilters);

            // √âv√©nement formulaire technicien
            document.getElementById('tech-form').addEventListener('submit', function(e) {
                e.preventDefault();
                createTechnician();
            });

            // Initialiser l'application
            initApp();
        });
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .collapsible-open {
            max-height: 500px;
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
        }
        .custom-file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">

    <!-- Section Connexion -->
    <div id="login-section" class="max-w-md mx-auto mt-20">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">üîê Connexion Administrateur</h2>
            
            <form class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="admin@ascenseur-paca.fr">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                    <input type="password" id="login-password" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Votre mot de passe">
                </div>
                
                <button type="button" onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                    Se connecter
                </button>
                
                <p id="login-status" class="text-center text-sm font-medium mt-4"></p>
            </form>
        </div>
    </div>

    <!-- Section Administration (cach√©e par d√©faut) -->
    <div id="admin-section" class="hidden">
        <div class="max-w-7xl mx-auto">
            <!-- En-t√™te -->
            <header class="text-center mb-8">
                <div class="flex justify-between items-center">
                    <div></div> <!-- Spacer -->
                    <div>
                        <h1 class="text-4xl font-bold text-gray-800 mb-2">
                            üìÅ Administration - Ascensoriste PACA
                        </h1>
                        <p class="text-gray-600">Gestion des documents et des techniciens</p>
                    </div>
                    <div id="user-info" class="hidden bg-white rounded-lg shadow px-4 py-2">
                        <p class="text-sm text-gray-600">Connect√© en tant que</p>
                        <p class="font-semibold" id="current-user-email"></p>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm mt-1">
                            üö™ D√©connexion
                        </button>
                    </div>
                </div>
                
                <!-- Statut connexion -->
                <div id="connection-status" class="mt-4 max-w-2xl mx-auto p-3 bg-blue-100 border border-blue-400 text-blue-700 rounded">
                    üîÑ Initialisation...
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Colonne de gauche : Upload + Gestion techniciens -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- Formulaire d'upload -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">üì§ Nouveau Document</h2>
                        
                        <form id="upload-form" class="space-y-4">
                            <!-- Marque -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Marque *</label>
                                <select id="input-marque" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></select>
                                <p id="add-status-marque" class="text-sm mt-1"></p>
                            </div>

                            <!-- Type -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                                <select id="input-type" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></select>
                                <p id="add-status-type" class="text-sm mt-1"></p>
                            </div>

                            <!-- Cat√©gorie -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cat√©gorie *</label>
                                <select id="input-categorie" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></select>
                                <p id="add-status-categorie" class="text-sm mt-1"></p>
                            </div>

                            <!-- Mod√®le -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mod√®le * (auto-rempli)</label>
                                <input type="text" id="input-model" required placeholder="Ex: GEN II LVA 2" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                            </div>

                            <!-- Fichier PDF -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fichier PDF *</label>
                                <label for="pdf-file" class="cursor-pointer bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg p-4 text-center block hover:bg-blue-100 transition">
                                    <span class="text-blue-600 font-medium">üìé Choisir un fichier PDF</span>
                                </label>
                                <input type="file" id="pdf-file" accept=".pdf" required class="custom-file-input">
                                <p id="file-name-display" class="text-sm text-gray-500 mt-2 text-center">Aucun fichier s√©lectionn√©</p>
                            </div>

                            <!-- Bouton submit -->
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                                üì§ Enregistrer le Document
                            </button>

                            <!-- Statut upload -->
                            <p id="upload-status" class="text-center text-sm font-medium"></p>
                        </form>
                    </div>

                    <!-- Gestion des techniciens -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">üë• Gestion des Techniciens</h2>
                        
                        <form id="tech-form" class="space-y-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                                <input type="text" id="tech-nom" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Dupont">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pr√©nom</label>
                                <input type="text" id="tech-prenom" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Jean">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="tech-email" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="jean.dupont@ascenseur-paca.fr">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                                <input type="password" id="tech-password" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="Minimum 8 caract√®res">
                            </div>
                            
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                                üë§ Cr√©er le compte technicien
                            </button>
                            
                            <p id="tech-status" class="text-center text-sm font-medium"></p>
                        </form>

                        <!-- Liste des techniciens -->
                        <div class="border-t pt-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Liste des techniciens</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="border-b p-2 text-left text-sm font-semibold">Nom</th>
                                            <th class="border-b p-2 text-left text-sm font-semibold">Email</th>
                                            <th class="border-b p-2 text-left text-sm font-semibold">R√¥le</th>
                                            <th class="border-b p-2 text-left text-sm font-semibold">Date cr√©ation</th>
                                            <th class="border-b p-2 text-left text-sm font-semibold">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="techniciens-list">
                                        <!-- Les techniciens seront charg√©s ici -->
                                    </tbody>
                                </table>
                            </div>
                            <p id="tech-list-status" class="text-center text-gray-600 mt-2 text-sm">
                                Chargement des techniciens...
                            </p>
                        </div>
                    </div>

                    <!-- Gestion des options (marques, types, cat√©gories) -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <button type="button" onclick="toggleCollapsible('manage-options-panel')" class="w-full text-left flex justify-between items-center text-lg font-bold text-gray-800 p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition">
                            <span>üõ†Ô∏è G√©rer les Options</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        
                        <div id="manage-options-panel" class="collapsible-content">
                            
                            <!-- Gestion des Marques -->
                            <div class="mt-4 border border-gray-200 rounded-lg p-3 bg-white">
                                <h3 class="text-base font-semibold text-gray-700 mb-2">Marques</h3>
                                <div id="manage-marques-list" class="max-h-40 overflow-y-auto space-y-1 mb-2">
                                    <!-- Liste des marques avec bouton de suppression -->
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="new-input-marque" placeholder="Nouvelle marque" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                                    <button type="button" onclick="addNewOption('marque')" class="bg-green-500 hover:bg-green-600 text-white rounded px-3 py-1 text-sm">
                                        Ajouter
                                    </button>
                                </div>
                            </div>

                            <!-- Gestion des Types -->
                            <div class="mt-4 border border-gray-200 rounded-lg p-3 bg-white">
                                <h3 class="text-base font-semibold text-gray-700 mb-2">Types</h3>
                                <div id="manage-types-list" class="max-h-40 overflow-y-auto space-y-1 mb-2">
                                    <!-- Liste des types avec bouton de suppression -->
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="new-input-type" placeholder="Nouveau type" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                                    <button type="button" onclick="addNewOption('type')" class="bg-green-500 hover:bg-green-600 text-white rounded px-3 py-1 text-sm">
                                        Ajouter
                                    </button>
                                </div>
                            </div>

                            <!-- Gestion des Cat√©gories -->
                            <div class="mt-4 border border-gray-200 rounded-lg p-3 bg-white">
                                <h3 class="text-base font-semibold text-gray-700 mb-2">Cat√©gories</h3>
                                <div id="manage-categories-list" class="max-h-40 overflow-y-auto space-y-1 mb-2">
                                    <!-- Liste des cat√©gories avec bouton de suppression -->
                                </div>
                                <div class="flex space-x-2">
                                    <input type="text" id="new-input-categorie" placeholder="Nouvelle cat√©gorie" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                                    <button type="button" onclick="addNewOption('categorie')" class="bg-green-500 hover:bg-green-600 text-white rounded px-3 py-1 text-sm">
                                        Ajouter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Colonne de droite : Liste des documents -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìö Documents Existants</h2>
                    
                    <!-- Filtres -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Marque</label>
                            <select id="filter-marque" class="w-full border border-gray-300 rounded px-2 py-1 text-sm"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Type</label>
                            <select id="filter-type" class="w-full border border-gray-300 rounded px-2 py-1 text-sm"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Cat√©gorie</label>
                            <select id="filter-categorie" class="w-full border border-gray-300 rounded px-2 py-1 text-sm"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Mod√®le</label>
                            <input type="text" id="filter-model" oninput="applyFilters()" placeholder="Recherche..." class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Fichier</label>
                            <input type="text" id="filter-search" oninput="applyFilters()" placeholder="Nom fichier..." class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                        </div>
                    </div>
                    
                    <!-- Tableau -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border-b p-3 text-left text-sm font-semibold">Marque</th>
                                    <th class="border-b p-3 text-left text-sm font-semibold">Type</th>
                                    <th class="border-b p-3 text-left text-sm font-semibold">Cat√©gorie</th>
                                    <th class="border-b p-3 text-left text-sm font-semibold">Mod√®le</th>
                                    <th class="border-b p-3 text-left text-sm font-semibold">Fichier</th>
                                    <th class="border-b p-3 text-left text-sm font-semibold">Action</th>
                                </tr>
                            </thead>
                            <tbody id="documents-table-body">
                                <!-- Les documents seront charg√©s ici -->
                            </tbody>
                        </table>
                    </div>
                    
                    <p id="documents-status" class="text-center text-gray-600 mt-4">
                        Chargement des documents...
                    </p>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
