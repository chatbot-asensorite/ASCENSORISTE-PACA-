<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Erreur 401</title>
</head>
<body>
    <h1>üîç DIAGNOSTIC ERREUR 401</h1>
    
    <div id="etapes">
        <h3>√âtapes de diagnostic :</h3>
        <ol>
            <li>Test de la cl√© API...</li>
            <li>V√©rification des permissions...</li>
            <li>Test de connexion simple...</li>
        </ol>
    </div>

    <div id="resultat" style="margin: 20px; padding: 15px; border: 1px solid #ccc;"></div>

    <script>
        async function diagnostic() {
            const resultat = document.getElementById('resultat');
            const url = 'https://prrzsosrbrskmeozmmmu.supabase.co';
            const cleApi = 'sb_publishable_2nwtPyBWSeUNNtx06wROTw_Txpyk2W3';
            
            // Test 1: Cl√© API basique
            resultat.innerHTML += "<h4>1. Test de la cl√© API...</h4>";
            try {
                const response = await fetch(url + '/rest/v1/documents', {
                    headers: {
                        'apikey': cleApi,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    resultat.innerHTML += `<p style="color:red">‚ùå ERREUR 401: Cl√© API INVALIDE ou expir√©e</p>`;
                } else if (response.ok) {
                    resultat.innerHTML += `<p style="color:green">‚úÖ Cl√© API VALIDE</p>`;
                } else {
                    resultat.innerHTML += `<p style="color:orange">‚ö†Ô∏è Statut: ${response.status}</p>`;
                }
            } catch (error) {
                resultat.innerHTML += `<p style="color:red">‚ùå Erreur: ${error.message}</p>`;
            }

            // Test 2: V√©rification RLS
            resultat.innerHTML += "<h4>2. V√©rification RLS...</h4>";
            try {
                const response = await fetch(url + '/rest/v1/documents?select=*&limit=1', {
                    headers: {
                        'apikey': cleApi,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (response.status === 401) {
                    resultat.innerHTML += `<p style="color:red">‚ùå RLS activ√© - Pas de politique d'acc√®s</p>`;
                } else {
                    resultat.innerHTML += `<p style="color:green">‚úÖ Acc√®s autoris√©</p>`;
                }
            } catch (error) {
                resultat.innerHTML += `<p style="color:red">‚ùå Erreur RLS: ${error.message}</p>`;
            }
        }

        // Lancer le diagnostic
        diagnostic();
    </script>

    <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 8px;">
        <h3>üö® SOLUTIONS POUR ERREUR 401 :</h3>
        <ol>
            <li><strong>R√©g√©n√©rer la cl√© API :</strong> Allez dans Supabase ‚Üí Settings ‚Üí API ‚Üí Regenerate</li>
            <li><strong>Activer RLS policies :</strong> Allez dans Authentication ‚Üí Policies ‚Üí Cr√©er des politiques</li>
            <li><strong>V√©rifier l'URL :</strong> Confirmez que l'URL est exacte</li>
        </ol>
        
        <h4>Solution rapide - D√©sactiver RLS :</h4>
        <p>Dans Supabase, allez dans <strong>Authentication ‚Üí Policies</strong> et d√©sactivez RLS pour la table "documents"</p>
        
        <button onclick="creerPolicies()">Cr√©er automatiquement les politiques</button>
        <div id="policiesResult"></div>
    </div>

    <script>
        async function creerPolicies() {
            const result = document.getElementById('policiesResult');
            result.innerHTML = "Cr√©ation des politiques...";
            
            // Ces commandes doivent √™tre ex√©cut√©es dans Supabase SQL Editor
            const sqlCommands = [
                "CREATE POLICY \"Allow all operations\" ON documents FOR ALL USING (true);",
                "CREATE POLICY \"Allow public select\" ON documents FOR SELECT USING (true);",
                "CREATE POLICY \"Allow public insert\" ON documents FOR INSERT WITH CHECK (true);"
            ];
            
            result.innerHTML = `
                <p>Ex√©cutez ces commandes dans <strong>Supabase ‚Üí SQL Editor</strong> :</p>
                <textarea style="width:100%; height:150px; font-family: monospace;">
${sqlCommands.join('\n\n')}
                </textarea>
                <p>Ou d√©sactivez simplement RLS dans Authentication ‚Üí Policies</p>
            `;
        }
    </script>
</body>
</html>
