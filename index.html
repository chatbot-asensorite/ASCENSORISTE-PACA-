<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ascensoriste PACA - Interface Technicien</title>
    <style>
        /* Styles g√©n√©raux */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f4f7f6;
            min-height: 100vh;
            padding: 0;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            box-shadow: none;
            overflow: hidden;
            min-height: 100vh;
        }
        
        .header {
            background: #007bff;
            color: white;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .role-selector {
            display: flex;
            justify-content: space-around;
            background: #0056b3;
            padding: 5px;
        }
        
        .role-btn {
            background: none;
            color: white;
            border: 1px solid transparent;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            flex-grow: 1;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        .role-btn.active {
            background: white;
            color: #007bff;
            border: 1px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .role-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .content {
            padding: 15px;
        }
        
        /* Styles du formulaire */
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 0;
        }
        
        .form-group {
            flex: none;
            margin-bottom: 15px;
        }
        
        label {
            margin-bottom: 5px;
            font-size: 0.9em;
            display: block;
        }
        
        .required::after {
            content: " *";
            color: red;
        }
        
        input[type="text"], select, input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }

        /* Styles suppl√©mentaires manquants */
        .select-with-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .hidden-panel {
            display: none;
            background: #f8f9fa;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .panel-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #495057;
        }

        .panel-content {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .items-list {
            margin-top: 10px;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .file-input-custom {
            padding: 10px;
            background: #007bff;
            color: white;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-name {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-btn {
            background: #28a745;
            color: white;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            font-size: 10px;
        }

        .toggle-table-btn {
            background: #6c757d;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }

        .table-section {
            display: none;
            margin-top: 20px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
            font-size: 0.8em;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        /* Interface Technicien */
        .technician-section {
            display: none;
            padding: 0;
        }
        
        .login-section {
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .technician-interface {
            background: white;
            padding: 0;
            display: none;
        }

        .search-section {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-section h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #007bff;
        }

        #technicianLogoutBtn {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            margin-top: 10px;
            width: auto;
        }

        #searchBtn {
            margin-top: 10px;
            background: #28a745;
        }

        /* R√©sultats et IA */
        .documents-found, .not-found-section, .ai-section {
            padding: 15px;
            margin-top: 0;
            border-radius: 0;
            display: none;
        }

        .document-list {
            gap: 10px;
            margin-top: 10px;
        }

        .document-card {
            padding: 10px;
            border-left: 5px solid #007bff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .document-card .view-btn {
            background: #007bff;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            margin-top: 5px;
        }

        #askAIBtn {
            margin-top: 15px;
            background: #6f42c1;
        }

        .ai-response {
            white-space: pre-wrap;
            font-size: 0.95em;
            padding: 15px;
            background: #e9ecef;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Sections Admin */
        .admin-login-section, .upload-section, .technician-management, .password-management {
            padding: 15px;
        }

        .admin-section {
            padding-top: 15px;
            display: none;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Media query pour desktop */
        @media (min-width: 601px) {
            body {
                padding: 20px;
            }
            .container {
                max-width: 1000px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                min-height: initial;
            }
            .content {
                padding: 30px;
            }
            .form-row {
                flex-direction: row;
            }
            .btn {
                width: auto;
            }
            #technicianLogoutBtn {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Ascensoriste PACA</h1>
            <p>Gestion des documents techniques</p>
            
            <div class="role-selector">
                <button class="role-btn active" id="adminBtn">üîß Admin</button>
                <button class="role-btn" id="technicianBtn">üë®‚Äçüîß Technicien</button>
            </div>
        </div>
        
        <div class="content">
            <!-- Section Admin -->
            <div class="admin-login-section" id="adminLoginSection">
                <h2>üîê Connexion Administrateur</h2>
                <p>Mot de passe requis</p>
                <div class="form-group" style="max-width: 300px; margin: 20px auto;">
                    <input type="password" id="adminPassword" placeholder="Mot de passe administrateur" style="text-align: center;">
                    <button class="btn" id="adminLoginBtn" style="margin-top: 15px;">Se connecter</button>
                </div>
                <div id="adminLoginStatus"></div>
            </div>
            
            <div class="admin-section" id="adminSection">
                <div style="text-align: right; margin-bottom: 15px;">
                    <button class="action-btn" id="adminLogoutBtn" style="background: #dc3545;">üö™ D√©connexion</button>
                </div>
                
                <div class="upload-section">
                    <h2>üì§ Ajouter un document</h2>
                    <form id="uploadForm">
                        <div class="form-row"> 
                            <div class="form-group">
                                <label for="marque" class="required">Marque</label>
                                <div class="select-with-actions">
                                    <select id="marque" name="marque" required>
                                        <option value="">S√©lectionnez une marque</option>
                                    </select>
                                    <button type="button" class="action-btn add-btn" id="manageMarquesBtn">‚öôÔ∏è</button>
                                </div>
                                <div class="hidden-panel" id="marquesPanel">
                                    <div class="panel-title">Gestion des marques</div>
                                    <div class="panel-content">
                                        <input type="text" id="newMarque" placeholder="Nouvelle marque">
                                        <button type="button" class="action-btn add-btn" id="addMarqueBtn">+</button>
                                    </div>
                                    <div class="items-list" id="marquesList"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="type_ascenseur" class="required">Type d'ascenseur</label>
                                <div class="select-with-actions">
                                    <select id="type_ascenseur" name="type_ascenseur" required>
                                        <option value="">S√©lectionnez un type</option>
                                    </select>
                                    <button type="button" class="action-btn add-btn" id="manageTypesBtn">‚öôÔ∏è</button>
                                </div>
                                <div class="hidden-panel" id="typesPanel">
                                    <div class="panel-title">Gestion des types d'ascenseur</div>
                                    <div class="panel-content">
                                        <input type="text" id="newType" placeholder="Nouveau type">
                                        <button type="button" class="action-btn add-btn" id="addTypeBtn">+</button>
                                    </div>
                                    <div class="items-list" id="typesList"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="categorie" class="required">Type de document</label>
                                <select id="categorie" name="categorie" required>
                                    <option value="">S√©lectionnez un type</option>
                                    <option value="programmation">Programmation</option>
                                    <option value="schemas">Sch√©mas</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="model" class="required">Mod√®le</label>
                                <input type="text" id="model" name="model" placeholder="Mod√®le sp√©cifique" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="pdfFile" class="required">Document PDF</label>
                            <div class="file-input-wrapper">
                                <div class="file-input-custom">
                                    üìé Choisir un fichier PDF
                                </div>
                                <input type="file" id="pdfFile" name="pdfFile" accept=".pdf" required>
                            </div>
                            <div class="file-name" id="fileName">Aucun fichier s√©lectionn√©</div>
                        </div>
                        
                        <button type="submit" class="btn">
                            üíæ Enregistrer le document
                        </button>
                    </form>
                    
                    <div id="statusMessage"></div>
                </div>
                
                <div class="technician-management">
                    <h2>üë®‚Äçüîß Gestion des Techniciens</h2>
                    
                    <div class="password-management">
                        <h3>üîë M.d.P Technicien</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newTechnicianPassword">Nouveau mot de passe technicien</label>
                                <input type="password" id="newTechnicianPassword" placeholder="Nouveau mot de passe">
                            </div>
                            <div class="form-group">
                                <label for="confirmTechnicianPassword">Confirmer</label>
                                <input type="password" id="confirmTechnicianPassword" placeholder="Confirmer le mot de passe">
                            </div>
                        </div>
                        <button class="btn" id="updateTechnicianPasswordBtn" style="background: #17a2b8;">
                            üîÑ Mettre √† jour
                        </button>
                        <div id="passwordStatus"></div>
                    </div>
                    
                    <div class="password-management">
                        <h3>üîë M.d.P Administrateur</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="currentAdminPassword">Actuel</label>
                                <input type="password" id="currentAdminPassword" placeholder="Mot de passe actuel">
                            </div>
                            <div class="form-group">
                                <label for="newAdminPassword">Nouveau</label>
                                <input type="password" id="newAdminPassword" placeholder="Nouveau mot de passe">
                            </div>
                            <div class="form-group">
                                <label for="confirmAdminPassword">Confirmer</label>
                                <input type="password" id="confirmAdminPassword" placeholder="Confirmer le mot de passe">
                            </div>
                        </div>
                        <button class="btn" id="updateAdminPasswordBtn" style="background: #6f42c1;">
                            üîÑ Mettre √† jour admin
                        </button>
                        <div id="adminPasswordStatus"></div>
                    </div>
                </div>
                
                <button id="toggleTableBtn" class="toggle-table-btn" style="width: 100%;">
                    üìä Afficher le tableau Supabase
                </button>
                
                <div class="table-section" id="tableSection">
                    <div class="table-header">
                        <h3 class="table-title">üìä Documents</h3>
                        <button class="refresh-btn" id="refreshTable">üîÑ Actualiser</button>
                    </div>
                    
                    <div id="tableContainer"></div>
                </div>
            </div>
            
            <!-- Section Technicien -->
            <div class="technician-section" id="technicianSection">
                <div class="login-section" id="loginSection">
                    <h2>üîê Acc√®s Technicien</h2>
                    <p>Entrez le mot de passe</p>
                    <div class="form-group" style="max-width: 300px; margin: 20px auto;">
                        <input type="password" id="technicianPassword" placeholder="Mot de passe technicien" style="text-align: center;">
                        <button class="btn" id="loginBtn" style="margin-top: 15px; background: #007bff;">Se connecter</button>
                    </div>
                    <div id="loginStatus"></div>
                </div>
                
                <div class="technician-interface" id="technicianInterface">
                    <div style="text-align: right; padding: 15px 15px 0 15px;">
                        <button class="action-btn" id="technicianLogoutBtn">üö™ D√©connexion</button>
                    </div>
                    
                    <div class="search-section">
                        <h3>üîç Recherche de documentation</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="techMarque">Marque</label>
                                <select id="techMarque">
                                    <option value="">S√©lectionnez une marque</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="techType">Type d'ascenseur</label>
                                <select id="techType">
                                    <option value="">S√©lectionnez un type</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="techModel">Mod√®le (Facultatif)</label>
                                <input type="text" id="techModel" placeholder="Mod√®le sp√©cifique">
                            </div>
                        </div>
                        <button class="btn" id="searchBtn">üöÄ Lancer la Recherche</button>
                    </div>
                    
                    <div class="documents-found" id="documentsFound">
                        <h3>‚úÖ Documents trouv√©s</h3>
                        <div class="document-list" id="documentList"></div>
                    </div>

                    <div class="not-found-section" id="notFoundSection">
                        <h3>‚ùå Doc. non disponible</h3>
                        <p>La documentation n'est pas encore dans la base.</p>
                        <button class="btn" id="askAIBtn" style="background: #6f42c1;">ü§ñ Demander √† l'IA</button>
                    </div>
                    
                    <div class="ai-section" id="aiSection">
                        <h3>ü§ñ Assistant IA Groq</h3>
                        <div class="ai-response" id="aiResponse">
                            L'assistant IA analyse votre demande...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://prrzsosrbrskmeozmmmu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBycnpzb3NyYnJza21lb3ptbW11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQxNzkxNDUsImV4cCI6MjA0OTc1NTE0NX0.9RZ_1wR3kCg8Q6aMESX3VPwD8NtoK-Q8rZJ4xJjWUVQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // √âtat de l'application
        let currentUser = null;
        let documents = [];
        let marques = [];
        let types = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadMarquesAndTypes();
        });

        function initializeApp() {
            // Cacher toutes les sections au d√©marrage
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('technicianSection').style.display = 'none';
            document.getElementById('technicianInterface').style.display = 'none';
            
            // Afficher seulement la connexion admin
            document.getElementById('adminLoginSection').style.display = 'block';
        }

        function setupEventListeners() {
            // Navigation entre les r√¥les
            document.getElementById('adminBtn').addEventListener('click', () => switchRole('admin'));
            document.getElementById('technicianBtn').addEventListener('click', () => switchRole('technician'));

            // Connexion
            document.getElementById('adminLoginBtn').addEventListener('click', adminLogin);
            document.getElementById('loginBtn').addEventListener('click', technicianLogin);

            // D√©connexion
            document.getElementById('adminLogoutBtn').addEventListener('click', logout);
            document.getElementById('technicianLogoutBtn').addEventListener('click', logout);

            // Gestion des documents
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
            document.getElementById('pdfFile').addEventListener('change', handleFileSelect);

            // Gestion des marques et types
            document.getElementById('manageMarquesBtn').addEventListener('click', () => togglePanel('marquesPanel'));
            document.getElementById('manageTypesBtn').addEventListener('click', () => togglePanel('typesPanel'));
            document.getElementById('addMarqueBtn').addEventListener('click', addMarque);
            document.getElementById('addTypeBtn').addEventListener('click', addType);

            // Mots de passe
            document.getElementById('updateTechnicianPasswordBtn').addEventListener('click', updateTechnicianPassword);
            document.getElementById('updateAdminPasswordBtn').addEventListener('click', updateAdminPassword);

            // Tableau
            document.getElementById('toggleTableBtn').addEventListener('click', toggleTable);
            document.getElementById('refreshTable').addEventListener('click', loadDocuments);

            // Recherche technicien
            document.getElementById('searchBtn').addEventListener('click', searchDocuments);
            document.getElementById('askAIBtn').addEventListener('click', askAI);
        }

        function switchRole(role) {
            const adminBtn = document.getElementById('adminBtn');
            const technicianBtn = document.getElementById('technicianBtn');
            
            adminBtn.classList.toggle('active', role === 'admin');
            technicianBtn.classList.toggle('active', role === 'technician');

            if (role === 'admin') {
                document.getElementById('technicianSection').style.display = 'none';
                document.getElementById('adminLoginSection').style.display = 'block';
            } else {
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'none';
                document.getElementById('technicianSection').style.display = 'block';
            }
        }

        async function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const statusDiv = document.getElementById('adminLoginStatus');
            
            if (!password) {
                showStatus(statusDiv, 'Veuillez entrer un mot de passe', 'error');
                return;
            }

            try {
                // V√©rifier le mot de passe admin (dans un vrai projet, cela serait s√©curis√©)
                const { data, error } = await supabase
                    .from('passwords')
                    .select('*')
                    .eq('role', 'admin')
                    .single();

                if (error) throw error;

                if (data && data.password === password) {
                    currentUser = { role: 'admin' };
                    document.getElementById('adminLoginSection').style.display = 'none';
                    document.getElementById('adminSection').style.display = 'block';
                    showStatus(statusDiv, 'Connexion r√©ussie!', 'success');
                    loadDocuments();
                } else {
                    showStatus(statusDiv, 'Mot de passe incorrect', 'error');
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showStatus(statusDiv, 'Erreur de connexion', 'error');
            }
        }

        async function technicianLogin() {
            const password = document.getElementById('technicianPassword').value;
            const statusDiv = document.getElementById('loginStatus');
            
            if (!password) {
                showStatus(statusDiv, 'Veuillez entrer un mot de passe', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('passwords')
                    .select('*')
                    .eq('role', 'technician')
                    .single();

                if (error) throw error;

                if (data && data.password === password) {
                    currentUser = { role: 'technician' };
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('technicianInterface').style.display = 'block';
                    showStatus(statusDiv, 'Connexion r√©ussie!', 'success');
                    loadMarquesAndTypesForTechnician();
                } else {
                    showStatus(statusDiv, 'Mot de passe incorrect', 'error');
                }
            } catch (error) {
                console.error('Erreur de connexion:', error);
                showStatus(statusDiv, 'Erreur de connexion', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('adminPassword').value = '';
            document.getElementById('technicianPassword').value = '';
            
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('technicianInterface').style.display = 'none';
            document.getElementById('tableSection').style.display = 'none';
            
            document.getElementById('adminLoginSection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'block';
        }

        async function loadMarquesAndTypes() {
            try {
                // Charger les marques
                const { data: marquesData, error: marquesError } = await supabase
                    .from('marques')
                    .select('*')
                    .order('name');

                if (marquesError) throw marquesError;
                marques = marquesData || [];

                // Charger les types
                const { data: typesData, error: typesError } = await supabase
                    .from('types_ascenseur')
                    .select('*')
                    .order('name');

                if (typesError) throw typesError;
                types = typesData || [];

                updateMarquesAndTypesSelects();
                updateMarquesAndTypesLists();
            } catch (error) {
                console.error('Erreur chargement marques/types:', error);
            }
        }

        function updateMarquesAndTypesSelects() {
            const marqueSelect = document.getElementById('marque');
            const techMarqueSelect = document.getElementById('techMarque');
            const typeSelect = document.getElementById('type_ascenseur');
            const techTypeSelect = document.getElementById('techType');

            // Mettre √† jour les selects admin
            marqueSelect.innerHTML = '<option value="">S√©lectionnez une marque</option>';
            typeSelect.innerHTML = '<option value="">S√©lectionnez un type</option>';

            // Mettre √† jour les selects technicien
            techMarqueSelect.innerHTML = '<option value="">S√©lectionnez une marque</option>';
            techTypeSelect.innerHTML = '<option value="">S√©lectionnez un type</option>';

            marques.forEach(marque => {
                const option = new Option(marque.name, marque.id);
                marqueSelect.add(option);
                techMarqueSelect.add(option.cloneNode(true));
            });

            types.forEach(type => {
                const option = new Option(type.name, type.id);
                typeSelect.add(option);
                techTypeSelect.add(option.cloneNode(true));
            });
        }

        function updateMarquesAndTypesLists() {
            const marquesList = document.getElementById('marquesList');
            const typesList = document.getElementById('typesList');

            marquesList.innerHTML = '';
            typesList.innerHTML = '';

            marques.forEach(marque => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <span>${marque.name}</span>
                    <button class="delete-btn" onclick="deleteMarque(${marque.id})">üóëÔ∏è</button>
                `;
                marquesList.appendChild(div);
            });

            types.forEach(type => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <span>${type.name}</span>
                    <button class="delete-btn" onclick="deleteType(${type.id})">üóëÔ∏è</button>
                `;
                typesList.appendChild(div);
            });
        }

        async function addMarque() {
            const newMarqueInput = document.getElementById('newMarque');
            const name = newMarqueInput.value.trim();

            if (!name) {
                alert('Veuillez entrer un nom de marque');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('marques')
                    .insert([{ name }])
                    .select();

                if (error) throw error;

                newMarqueInput.value = '';
                await loadMarquesAndTypes();
                showStatus(document.getElementById('statusMessage'), 'Marque ajout√©e avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur ajout marque:', error);
                showStatus(document.getElementById('statusMessage'), 'Erreur lors de l\'ajout', 'error');
            }
        }

        async function addType() {
            const newTypeInput = document.getElementById('newType');
            const name = newTypeInput.value.trim();

            if (!name) {
                alert('Veuillez entrer un nom de type');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('types_ascenseur')
                    .insert([{ name }])
                    .select();

                if (error) throw error;

                newTypeInput.value = '';
                await loadMarquesAndTypes();
                showStatus(document.getElementById('statusMessage'), 'Type ajout√© avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur ajout type:', error);
                showStatus(document.getElementById('statusMessage'), 'Erreur lors de l\'ajout', 'error');
            }
        }

        async function deleteMarque(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette marque ?')) return;

            try {
                const { error } = await supabase
                    .from('marques')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await loadMarquesAndTypes();
                showStatus(document.getElementById('statusMessage'), 'Marque supprim√©e avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur suppression marque:', error);
                showStatus(document.getElementById('statusMessage'), 'Erreur lors de la suppression', 'error');
            }
        }

        async function deleteType(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce type ?')) return;

            try {
                const { error } = await supabase
                    .from('types_ascenseur')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await loadMarquesAndTypes();
                showStatus(document.getElementById('statusMessage'), 'Type supprim√© avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur suppression type:', error);
                showStatus(document.getElementById('statusMessage'), 'Erreur lors de la suppression', 'error');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileNameDiv = document.getElementById('fileName');
            
            if (file) {
                fileNameDiv.textContent = `Fichier s√©lectionn√©: ${file.name}`;
            } else {
                fileNameDiv.textContent = 'Aucun fichier s√©lectionn√©';
            }
        }

        async function handleUpload(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const marqueId = formData.get('marque');
            const typeId = formData.get('type_ascenseur');
            const categorie = formData.get('categorie');
            const model = formData.get('model');
            const pdfFile = document.getElementById('pdfFile').files[0];

            if (!pdfFile) {
                showStatus(document.getElementById('statusMessage'), 'Veuillez s√©lectionner un fichier PDF', 'error');
                return;
            }

            try {
                // Upload du fichier PDF
                const fileExt = pdfFile.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`;

                const { data: fileData, error: uploadError } = await supabase.storage
                    .from('documents')
                    .upload(fileName, pdfFile);

                if (uploadError) throw uploadError;

                // Enregistrement dans la base de donn√©es
                const { data, error } = await supabase
                    .from('documents')
                    .insert([{
                        marque_id: marqueId,
                        type_ascenseur_id: typeId,
                        categorie,
                        model,
                        file_path: fileName,
                        file_name: pdfFile.name
                    }])
                    .select();

                if (error) throw error;

                // R√©initialiser le formulaire
                event.target.reset();
                document.getElementById('fileName').textContent = 'Aucun fichier s√©lectionn√©';
                
                showStatus(document.getElementById('statusMessage'), 'Document upload√© avec succ√®s!', 'success');
                loadDocuments();
            } catch (error) {
                console.error('Erreur upload:', error);
                showStatus(document.getElementById('statusMessage'), 'Erreur lors de l\'upload', 'error');
            }
        }

        async function loadDocuments() {
            try {
                const { data, error } = await supabase
                    .from('documents')
                    .select(`
                        *,
                        marques(name),
                        types_ascenseur(name)
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                documents = data || [];
                updateTable();
            } catch (error) {
                console.error('Erreur chargement documents:', error);
            }
        }

        function updateTable() {
            const tableContainer = document.getElementById('tableContainer');
            
            if (documents.length === 0) {
                tableContainer.innerHTML = '<p>Aucun document trouv√©</p>';
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Marque</th>
                            <th>Type</th>
                            <th>Mod√®le</th>
                            <th>Cat√©gorie</th>
                            <th>Fichier</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            documents.forEach(doc => {
                html += `
                    <tr>
                        <td>${doc.marques?.name || 'N/A'}</td>
                        <td>${doc.types_ascenseur?.name || 'N/A'}</td>
                        <td>${doc.model}</td>
                        <td>${doc.categorie}</td>
                        <td>${doc.file_name}</td>
                        <td>${new Date(doc.created_at).toLocaleDateString()}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        function toggleTable() {
            const tableSection = document.getElementById('tableSection');
            const toggleBtn = document.getElementById('toggleTableBtn');
            
            if (tableSection.style.display === 'none' || !tableSection.style.display) {
                tableSection.style.display = 'block';
                toggleBtn.textContent = 'üìä Masquer le tableau Supabase';
                loadDocuments();
            } else {
                tableSection.style.display = 'none';
                toggleBtn.textContent = 'üìä Afficher le tableau Supabase';
            }
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        async function loadMarquesAndTypesForTechnician() {
            // Recharger les donn√©es pour le technicien
            await loadMarquesAndTypes();
        }

        async function searchDocuments() {
            const marqueId = document.getElementById('techMarque').value;
            const typeId = document.getElementById('techType').value;
            const model = document.getElementById('techModel').value.trim();

            // Cacher toutes les sections de r√©sultats
            document.getElementById('documentsFound').style.display = 'none';
            document.getElementById('notFoundSection').style.display = 'none';
            document.getElementById('aiSection').style.display = 'none';

            if (!marqueId && !typeId && !model) {
                alert('Veuillez remplir au moins un crit√®re de recherche');
                return;
            }

            try {
                let query = supabase
                    .from('documents')
                    .select(`
                        *,
                        marques(name),
                        types_ascenseur(name)
                    `);

                if (marqueId) query = query.eq('marque_id', marqueId);
                if (typeId) query = query.eq('type_ascenseur_id', typeId);
                if (model) query = query.ilike('model', `%${model}%`);

                const { data, error } = await query;

                if (error) throw error;

                if (data && data.length > 0) {
                    displayFoundDocuments(data);
                } else {
                    document.getElementById('notFoundSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur recherche:', error);
                alert('Erreur lors de la recherche');
            }
        }

        function displayFoundDocuments(docs) {
            const documentList = document.getElementById('documentList');
            documentList.innerHTML = '';

            docs.forEach(doc => {
                const docCard = document.createElement('div');
                docCard.className = 'document-card';
                docCard.innerHTML = `
                    <h4>${doc.marques?.name || 'N/A'} - ${doc.types_ascenseur?.name || 'N/A'}</h4>
                    <p><strong>Mod√®le:</strong> ${doc.model}</p>
                    <p><strong>Type:</strong> ${doc.categorie}</p>
                    <p><strong>Fichier:</strong> ${doc.file_name}</p>
                    <button class="view-btn" onclick="viewDocument('${doc.file_path}', '${doc.file_name}')">
                        üëÅÔ∏è Voir le document
                    </button>
                `;
                documentList.appendChild(docCard);
            });

            document.getElementById('documentsFound').style.display = 'block';
        }

        async function viewDocument(filePath, fileName) {
            try {
                const { data, error } = await supabase.storage
                    .from('documents')
                    .createSignedUrl(filePath, 3600); // Lien valide 1 heure

                if (error) throw error;

                if (data) {
                    window.open(data.signedUrl, '_blank');
                }
            } catch (error) {
                console.error('Erreur visualisation document:', error);
                alert('Erreur lors de l\'ouverture du document');
            }
        }

        async function askAI() {
            const marqueId = document.getElementById('techMarque').value;
            const typeId = document.getElementById('techType').value;
            const model = document.getElementById('techModel').value.trim();

            const marqueSelect = document.getElementById('techMarque');
            const typeSelect = document.getElementById('techType');
            
            const marqueName = marqueSelect.options[marqueSelect.selectedIndex]?.text || '';
            const typeName = typeSelect.options[typeSelect.selectedIndex]?.text || '';

            const aiResponse = document.getElementById('aiResponse');
            aiResponse.textContent = 'Analyse en cours...';
            document.getElementById('aiSection').style.display = 'block';

            // Simulation de r√©ponse IA (dans un vrai projet, int√©gration avec une API IA)
            setTimeout(() => {
                const responses = [
                    `Pour l'ascenseur ${marqueName} ${typeName} mod√®le ${model || 'non sp√©cifi√©'}, je recommande de v√©rifier d'abord le module de commande principal. Les documents techniques sp√©cifiques ne sont pas encore disponibles dans notre base, mais la proc√©dure standard pour ce type d'appareil est de...`,

                    `Concernant ${marqueName} ${typeName}, voici quelques conseils techniques g√©n√©raux : 1. V√©rifiez l'alimentation √©lectrique 2. Contr√¥lez les capteurs de s√©curit√© 3. Inspectez le syst√®me de freinage. La documentation d√©taill√©e sera bient√¥t disponible.`,

                    `L'ascenseur ${marqueName} de type ${typeName} utilise g√©n√©ralement un syst√®me de contr√¥le standard. En attendant la documentation sp√©cifique, voici les √©tapes de d√©pannage de base...`
                ];

                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                aiResponse.textContent = randomResponse;
            }, 2000);
        }

        async function updateTechnicianPassword() {
            const newPassword = document.getElementById('newTechnicianPassword').value;
            const confirmPassword = document.getElementById('confirmTechnicianPassword').value;
            const statusDiv = document.getElementById('passwordStatus');

            if (!newPassword || !confirmPassword) {
                showStatus(statusDiv, 'Veuillez remplir tous les champs', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showStatus(statusDiv, 'Les mots de passe ne correspondent pas', 'error');
                return;
            }

            try {
                const { error } = await supabase
                    .from('passwords')
                    .update({ password: newPassword })
                    .eq('role', 'technician');

                if (error) throw error;

                document.getElementById('newTechnicianPassword').value = '';
                document.getElementById('confirmTechnicianPassword').value = '';
                showStatus(statusDiv, 'Mot de passe technicien mis √† jour avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur mise √† jour mot de passe:', error);
                showStatus(statusDiv, 'Erreur lors de la mise √† jour', 'error');
            }
        }

        async function updateAdminPassword() {
            const currentPassword = document.getElementById('currentAdminPassword').value;
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            const statusDiv = document.getElementById('adminPasswordStatus');

            if (!currentPassword || !newPassword || !confirmPassword) {
                showStatus(statusDiv, 'Veuillez remplir tous les champs', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showStatus(statusDiv, 'Les nouveaux mots de passe ne correspondent pas', 'error');
                return;
            }

            try {
                // V√©rifier le mot de passe actuel
                const { data, error: checkError } = await supabase
                    .from('passwords')
                    .select('*')
                    .eq('role', 'admin')
                    .single();

                if (checkError) throw checkError;

                if (!data || data.password !== currentPassword) {
                    showStatus(statusDiv, 'Mot de passe actuel incorrect', 'error');
                    return;
                }

                // Mettre √† jour le mot de passe
                const { error } = await supabase
                    .from('passwords')
                    .update({ password: newPassword })
                    .eq('role', 'admin');

                if (error) throw error;

                document.getElementById('currentAdminPassword').value = '';
                document.getElementById('newAdminPassword').value = '';
                document.getElementById('confirmAdminPassword').value = '';
                showStatus(statusDiv, 'Mot de passe admin mis √† jour avec succ√®s', 'success');
            } catch (error) {
                console.error('Erreur mise √† jour mot de passe admin:', error);
                showStatus(statusDiv, 'Erreur lors de la mise √† jour', 'error');
            }
        }

        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.style.display = 'block';

            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Fonctions globales pour les boutons de suppression
        window.deleteMarque = deleteMarque;
        window.deleteType = deleteType;
        window.viewDocument = viewDocument;
    </script>
</body>
</html>
