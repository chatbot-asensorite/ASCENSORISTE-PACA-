<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface D√©pannage Ascenseurs - Auto-d√©tection</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #007cba; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .file-drop { border: 2px dashed #007cba; padding: 30px; text-align: center; border-radius: 10px; margin: 15px 0; background: #f0f8ff; }
        .document-item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .table-info { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .columns-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .column-item { background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #007cba; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Interface D√©pannage Ascenseurs - Auto-d√©tection</h1>
        
        <!-- Section Information Table -->
        <div class="table-info">
            <h3>üìä Structure de votre table d√©tect√©e automatiquement</h3>
            <div id="tableStructure">
                <p>Chargement de la structure...</p>
            </div>
        </div>

        <!-- Section Upload -->
        <div class="section">
            <h2>üì§ Ajouter un nouveau document</h2>
            
            <div id="dynamicForm">
                <!-- Le formulaire sera g√©n√©r√© automatiquement ici -->
                <p>Chargement du formulaire...</p>
            </div>

            <div class="form-group">
                <label>S√©lectionner le fichier PDF *</label>
                <div class="file-drop" id="fileDrop">
                    <p>üìé Glissez-d√©posez votre fichier PDF ici ou</p>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <button type="button" onclick="document.getElementById('fileInput').click()">
                        Parcourir les fichiers
                    </button>
                    <p id="fileName" style="margin-top: 10px; font-style: italic;"></p>
                </div>
            </div>
            
            <button onclick="uploadDocument()" id="uploadBtn" disabled>üöÄ Uploader le document</button>
            <button onclick="chargerStructure()">üîÑ Actualiser la structure</button>
            
            <div id="uploadResult"></div>
        </div>

        <!-- Section Recherche -->
        <div class="section">
            <h2>üîç Rechercher dans les documents</h2>
            
            <div class="form-group">
                <input type="text" id="searchInput" placeholder="Rechercher par marque, mod√®le, description..." 
                       style="width: 70%; display: inline-block;">
                <button onclick="rechercherDocuments()" style="width: 25%;">üîç Rechercher</button>
            </div>
            
            <div id="searchResults">
                <!-- Les r√©sultats de recherche appara√Ætront ici -->
            </div>
        </div>

        <!-- Section Liste des documents -->
        <div class="section">
            <h2>üìã Tous les documents</h2>
            <button onclick="chargerDocuments()">üîÑ Actualiser la liste</button>
            <div id="documentsList">
                Chargement en cours...
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://prrzsosrbrskmeozmmmu.supabase.co';
        const supabaseKey = 'sb_publishable_2nwtPyBWSeUNNtx06wROTw_Txpyk2W3';
        const { createClient } = supabase;
        const client = createClient(supabaseUrl, supabaseKey);

        let selectedFile = null;
        let tableStructure = [];

        // Charger la structure de la table au d√©marrage
        document.addEventListener('DOMContentLoaded', function() {
            chargerStructure();
            chargerDocuments();
        });

        // Fonction pour d√©tecter la structure de la table
        async function chargerStructure() {
            const structureDiv = document.getElementById('tableStructure');
            structureDiv.innerHTML = "üîç D√©tection de la structure en cours...";

            try {
                // R√©cup√©rer un √©chantillon pour d√©tecter les colonnes
                const { data, error } = await client
                    .from('documents')
                    .select('*')
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    // D√©tecter les colonnes (exclure id, created_at, etc.)
                    const sample = data[0];
                    tableStructure = Object.keys(sample).filter(col => 
                        !['id', 'created_at', 'updated_at', 'path', 'filename'].includes(col)
                    );

                    // Afficher la structure d√©tect√©e
                    let html = '<div class="columns-list">';
                    tableStructure.forEach(column => {
                        html += `<div class="column-item">${column}</div>`;
                    });
                    html += '</div>';
                    structureDiv.innerHTML = html;

                    // G√©n√©rer le formulaire dynamique
                    genererFormulaire();
                } else {
                    structureDiv.innerHTML = '<p class="info">üì≠ La table est vide. Les colonnes seront d√©tect√©es apr√®s le premier upload.</p>';
                    // Structure par d√©faut bas√©e sur votre description
                    tableStructure = ['marque', 'model', 'programmation', 'schemas'];
                    genererFormulaire();
                }
            } catch (error) {
                structureDiv.innerHTML = `<p class="error">‚ùå Erreur lors de la d√©tection: ${error.message}</p>`;
            }
        }

        // G√©n√©rer le formulaire dynamiquement
        function genererFormulaire() {
            const formDiv = document.getElementById('dynamicForm');
            let html = '';

            tableStructure.forEach(column => {
                const label = column.charAt(0).toUpperCase() + column.slice(1);
                const required = ['marque', 'model'].includes(column);
                
                html += `
                    <div class="form-group">
                        <label>${label} ${required ? '*' : ''}</label>
                        <input type="text" id="form_${column}" 
                               placeholder="Entrez ${column}..." 
                               ${required ? 'required' : ''}>
                    </div>
                `;
            });

            formDiv.innerHTML = html;
        }

        // Gestion de la s√©lection de fichier
        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (selectedFile && selectedFile.type === 'application/pdf') {
                document.getElementById('fileName').textContent = 
                    `Fichier s√©lectionn√©: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                document.getElementById('uploadBtn').disabled = false;
            } else {
                alert('‚ùå Veuillez s√©lectionner un fichier PDF');
                selectedFile = null;
                document.getElementById('fileName').textContent = '';
                document.getElementById('uploadBtn').disabled = true;
            }
        });

        // Drag and drop
        const fileDrop = document.getElementById('fileDrop');
        ['dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDrop.addEventListener(eventName, function(e) {
                e.preventDefault();
                if (eventName === 'dragover') {
                    fileDrop.style.background = '#e6f3ff';
                } else if (eventName === 'dragleave') {
                    fileDrop.style.background = '#f0f8ff';
                } else if (eventName === 'drop') {
                    fileDrop.style.background = '#f0f8ff';
                    selectedFile = e.dataTransfer.files[0];
                    if (selectedFile && selectedFile.type === 'application/pdf') {
                        document.getElementById('fileName').textContent = 
                            `Fichier s√©lectionn√©: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                        document.getElementById('uploadBtn').disabled = false;
                    } else {
                        alert('‚ùå Veuillez d√©poser un fichier PDF');
                        selectedFile = null;
                    }
                }
            });
        });

        // Upload du document
        async function uploadDocument() {
            const uploadBtn = document.getElementById('uploadBtn');
            const resultDiv = document.getElementById('uploadResult');

            // V√©rifier les champs requis
            const marque = document.getElementById('form_marque')?.value;
            const model = document.getElementById('form_model')?.value;

            if (!marque || !model || !selectedFile) {
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez remplir les champs marque, mod√®le et s√©lectionner un fichier</div>';
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Upload en cours...';
            resultDiv.innerHTML = '';

            try {
                // Cr√©er l'objet de donn√©es dynamiquement
                const documentData = {
                    created_at: new Date().toISOString()
                };

                // Remplir avec les donn√©es du formulaire
                tableStructure.forEach(column => {
                    const input = document.getElementById(`form_${column}`);
                    if (input && input.value) {
                        documentData[column] = input.value;
                    }
                });

                // Ajouter le nom du fichier
                documentData.filename = selectedFile.name;

                // Enregistrement dans la base de donn√©es
                const { data: dbData, error: dbError } = await client
                    .from('documents')
                    .insert([documentData]);

                if (dbError) throw dbError;

                resultDiv.innerHTML = '<div class="success">‚úÖ Document enregistr√© avec succ√®s dans la base de donn√©es!</div>';
                
                // R√©initialiser le formulaire
                tableStructure.forEach(column => {
                    const input = document.getElementById(`form_${column}`);
                    if (input) input.value = '';
                });
                document.getElementById('fileName').textContent = '';
                selectedFile = null;
                document.getElementById('fileInput').value = '';
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'üöÄ Uploader le document';

                // Recharger les donn√©es
                setTimeout(() => {
                    chargerDocuments();
                    chargerStructure();
                }, 1000);

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Uploader le document';
            }
        }

        // Charger tous les documents
        async function chargerDocuments() {
            const listDiv = document.getElementById('documentsList');
            listDiv.innerHTML = 'Chargement...';

            try {
                const { data, error } = await client
                    .from('documents')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    listDiv.innerHTML = '<p class="info">Aucun document trouv√©.</p>';
                    return;
                }

                let html = `<p>üìÑ ${data.length} document(s) trouv√©(s)</p>`;
                data.forEach(doc => {
                    html += `
                        <div class="document-item">
                            <h4>${doc.marque || 'N/A'} - ${doc.model || 'N/A'}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0;">
                    `;
                    
                    // Afficher dynamiquement toutes les colonnes
                    Object.keys(doc).forEach(key => {
                        if (doc[key] && !['id', 'created_at', 'updated_at'].includes(key)) {
                            html += `<div><strong>${key}:</strong> ${doc[key]}</div>`;
                        }
                    });
                    
                    html += `
                            </div>
                            <p><em>Cr√©√© le: ${new Date(doc.created_at).toLocaleDateString('fr-FR')}</em></p>
                        </div>
                    `;
                });

                listDiv.innerHTML = html;
            } catch (error) {
                listDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }

        // Rechercher des documents
        async function rechercherDocuments() {
            const searchTerm = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('searchResults');

            if (!searchTerm) {
                resultsDiv.innerHTML = '<p class="info">‚ö†Ô∏è Veuillez entrer un terme de recherche</p>';
                return;
            }

            resultsDiv.innerHTML = 'Recherche en cours...';

            try {
                const { data, error } = await client
                    .from('documents')
                    .select('*')
                    .or(`marque.ilike.%${searchTerm}%,model.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    resultsDiv.innerHTML = '<p class="info">üîç Aucun document trouv√© pour cette recherche.</p>';
                    return;
                }

                let html = `<h3>üîç ${data.length} r√©sultat(s) pour "${searchTerm}"</h3>`;
                data.forEach(doc => {
                    html += `
                        <div class="document-item">
                            <h4>${doc.marque || 'N/A'} - ${doc.model || 'N/A'}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0;">
                    `;
                    
                    Object.keys(doc).forEach(key => {
                        if (doc[key] && !['id', 'created_at', 'updated_at'].includes(key)) {
                            html += `<div><strong>${key}:</strong> ${doc[key]}</div>`;
                        }
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Erreur recherche: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
