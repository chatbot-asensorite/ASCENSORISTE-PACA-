<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Documents Ascenseurs</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #007cba; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .file-drop { border: 2px dashed #007cba; padding: 40px; text-align: center; border-radius: 10px; margin: 20px 0; background: #f0f8ff; }
        .error { color: red; font-weight: bold; background: #ffe6e6; padding: 10px; border-radius: 5px; }
        .success { color: green; font-weight: bold; background: #e6ffe6; padding: 10px; border-radius: 5px; }
        .warning { color: orange; font-weight: bold; background: #fff3cd; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì§ Upload Documents Ascenseurs</h1>
        
        <!-- Message de configuration -->
        <div class="warning" id="configMessage">
            <h3>‚ö†Ô∏è Configuration Requise</h3>
            <p>Avant de pouvoir uploader, cr√©ez le bucket Storage dans Supabase :</p>
            <ol>
                <li>Allez dans <strong>Storage</strong></li>
                <li>Cliquez sur <strong>"New Bucket"</strong></li>
                <li>Nom: <strong>"documents"</strong></li>
                <li>Public: <strong>ACTIV√â</strong></li>
                <li>Cliquez sur <strong>"Create bucket"</strong></li>
            </ol>
            <button onclick="verifierBucket()">üîÑ V√©rifier le bucket</button>
        </div>

        <!-- Formulaire d'upload -->
        <div class="form-section">
            <h2>Ajouter un nouveau document</h2>
            
            <div class="form-group">
                <label>Marque *</label>
                <input type="text" id="marque" placeholder="Schindler, Otis, Kone..." required>
            </div>
            
            <div class="form-group">
                <label>Mod√®le *</label>
                <input type="text" id="model" placeholder="3300, Gen2, MonoSpace..." required>
            </div>
            
            <div class="form-group">
                <label>Description</label>
                <textarea id="description" placeholder="Description du document..." rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label>S√©lectionner le fichier PDF *</label>
                <div class="file-drop" id="fileDrop">
                    <p>üìé Glissez-d√©posez votre fichier PDF ici ou</p>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <button type="button" onclick="document.getElementById('fileInput').click()">
                        Parcourir les fichiers
                    </button>
                    <p id="fileName" style="margin-top: 10px; font-style: italic;"></p>
                </div>
            </div>
            
            <button onclick="uploadDocument()" id="uploadBtn" disabled>üöÄ Uploader le document</button>
            <button onclick="chargerDocuments()">üîÑ Actualiser la liste</button>
            
            <div id="uploadResult"></div>
        </div>
        
        <!-- Liste des documents -->
        <div class="document-list">
            <h2>üìã Documents existants</h2>
            <div id="documentsList">
                Chargement en cours...
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://prrzsosrbrskmeozmmmu.supabase.co';
        const supabaseKey = 'sb_publishable_2nwtPyBWSeUNNtx06wROTw_Txpyk2W3';
        const { createClient } = supabase;
        const client = createClient(supabaseUrl, supabaseKey);

        let selectedFile = null;

        // V√©rifier si le bucket existe
        async function verifierBucket() {
            const messageDiv = document.getElementById('configMessage');
            
            try {
                const { data, error } = await client.storage
                    .from('documents')
                    .list();
                
                if (error && error.message.includes('Bucket')) {
                    messageDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Bucket non trouv√©</h3>
                            <p>Le bucket "documents" n'existe pas. Cr√©ez-le dans Supabase Storage.</p>
                            <button onclick="verifierBucket()">üîÑ R√©essayer</button>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Bucket trouv√©!</h3>
                            <p>Le bucket "documents" est accessible. Vous pouvez maintenant uploader des fichiers.</p>
                        </div>
                    `;
                }
            } catch (error) {
                messageDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erreur de v√©rification</h3>
                        <p>${error.message}</p>
                        <button onclick="verifierBucket()">üîÑ R√©essayer</button>
                    </div>
                `;
            }
        }

        // Gestion de la s√©lection de fichier
        document.getElementById('fileInput').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                if (selectedFile.type === 'application/pdf') {
                    document.getElementById('fileName').textContent = `Fichier s√©lectionn√©: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    alert('‚ùå Veuillez s√©lectionner un fichier PDF');
                    selectedFile = null;
                    document.getElementById('fileName').textContent = '';
                    document.getElementById('uploadBtn').disabled = true;
                }
            }
        });

        // Drag and drop
        const fileDrop = document.getElementById('fileDrop');
        fileDrop.addEventListener('dragover', function(e) {
            e.preventDefault();
            fileDrop.style.background = '#e6f3ff';
        });
        
        fileDrop.addEventListener('dragleave', function(e) {
            e.preventDefault();
            fileDrop.style.background = '#f0f8ff';
        });
        
        fileDrop.addEventListener('drop', function(e) {
            e.preventDefault();
            fileDrop.style.background = '#f0f8ff';
            selectedFile = e.dataTransfer.files[0];
            if (selectedFile && selectedFile.type === 'application/pdf') {
                document.getElementById('fileName').textContent = `Fichier s√©lectionn√©: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                document.getElementById('uploadBtn').disabled = false;
            } else {
                alert('‚ùå Veuillez d√©poser un fichier PDF');
                selectedFile = null;
            }
        });

        // Fonction d'upload
        async function uploadDocument() {
            const marque = document.getElementById('marque').value;
            const model = document.getElementById('model').value;
            const description = document.getElementById('description').value;
            const uploadBtn = document.getElementById('uploadBtn');
            const resultDiv = document.getElementById('uploadResult');

            if (!marque || !model || !selectedFile) {
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez remplir tous les champs obligatoires</div>';
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Upload en cours...';
            resultDiv.innerHTML = '';

            try {
                // Cr√©er un nom de fichier unique
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `${marque}_${model}_${Date.now()}.${fileExt}`;
                const filePath = `${fileName}`;

                // Upload du fichier
                const { data: uploadData, error: uploadError } = await client.storage
                    .from('documents')
                    .upload(filePath, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    if (uploadError.message.includes('Bucket')) {
                        throw new Error('Bucket "documents" non trouv√©. Cr√©ez-le dans Supabase Storage.');
                    }
                    throw new Error(`Erreur upload: ${uploadError.message}`);
                }

                // Enregistrement dans la table documents
                const { data: dbData, error: dbError } = await client
                    .from('documents')
                    .insert([
                        {
                            marque: marque,
                            model: model,
                            description: description,
                            filename: selectedFile.name,
                            path: filePath,
                            created_at: new Date().toISOString()
                        }
                    ]);

                if (dbError) {
                    throw new Error(`Erreur base de donn√©es: ${dbError.message}`);
                }

                resultDiv.innerHTML = '<div class="success">‚úÖ Document upload√© avec succ√®s!</div>';
                
                // R√©initialiser le formulaire
                document.getElementById('marque').value = '';
                document.getElementById('model').value = '';
                document.getElementById('description').value = '';
                document.getElementById('fileName').textContent = '';
                selectedFile = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('uploadBtn').textContent = 'üöÄ Uploader le document';

                // Recharger la liste
                chargerDocuments();

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Uploader le document';
            }
        }

        // Charger la liste des documents
        async function chargerDocuments() {
            const listDiv = document.getElementById('documentsList');
            
            try {
                const { data, error } = await client
                    .from('documents')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    listDiv.innerHTML = '<p>Aucun document trouv√©.</p>';
                    return;
                }

                let html = '';
                data.forEach(doc => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <h4>${doc.marque} - ${doc.model}</h4>
                            <p><strong>Fichier:</strong> ${doc.filename}</p>
                            ${doc.description ? `<p><strong>Description:</strong> ${doc.description}</p>` : ''}
                            <p><strong>Date:</strong> ${new Date(doc.created_at).toLocaleDateString('fr-FR')}</p>
                        </div>
                    `;
                });

                listDiv.innerHTML = html;
            } catch (error) {
                listDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }

        // V√©rifier le bucket au chargement
        verifierBucket();
        chargerDocuments();
    </script>
</body>
</html>
